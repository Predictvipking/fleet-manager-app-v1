<!DOCTYPE html>
<html lang="en" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Utility Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        /* --- THEME (Lute Light) --- */
        :root {
            --bg-body: #f3f6fc;
            --bg-card: #ffffff;
            --primary: #4f46e5; 
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); -webkit-tap-highlight-color: transparent; user-select: none; }

        /* Login */
        .login-bg { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }

        /* UI Elements */
        .card-ui {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            padding: 1.25rem; margin-bottom: 1rem;
        }

        .input-ui {
            width: 100%; padding: 12px; background: #f8fafc; 
            border: 1px solid var(--border); border-radius: 10px;
            color: var(--text-main); font-weight: 500; transition: 0.3s;
        }
        .input-ui:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .btn-primary {
            background: var(--primary); color: white; padding: 12px; 
            border-radius: 10px; font-weight: 700; letter-spacing: 0.5px;
            width: 100%; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:active { transform: scale(0.96); }

        /* History Items */
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 8px;
            border: 1px solid #e2e8f0; border-left: 4px solid var(--primary);
        }

        /* Bottom Nav */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            height: 70px; display: flex; align-items: center; justify-content: space-around;
            padding-bottom: 5px; position: fixed; bottom: 0; width: 100%; z-index: 50;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; 
            color: #94a3b8; width: 50px; transition: 0.3s;
        }
        .nav-item i { font-size: 1.6rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- 1. LOGIN SCREEN -->
    <div id="authSection" class="fixed inset-0 z-50 flex items-center justify-center p-6 login-bg">
        <div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-xl fade-in border border-white">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600">
                    <i class="fa-solid fa-bolt text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Utility Master</h1>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Enterprise Edition</p>
            </div>

            <div id="loginForm" class="space-y-4">
                <input type="email" id="logEmail" class="input-ui" placeholder="User ID">
                <input type="password" id="logPass" class="input-ui" placeholder="Password">
                <button onclick="handleLogin()" id="loginBtn" class="btn-primary">LOGIN DASHBOARD</button>
                <p class="text-center text-xs text-slate-400 mt-4 cursor-pointer" onclick="toggleAuth('signup')">Create Account</p>
            </div>

            <div id="signupForm" class="space-y-4 hidden">
                <input type="text" id="signName" class="input-ui" placeholder="Full Name">
                <input type="email" id="signEmail" class="input-ui" placeholder="Email Address">
                <input type="password" id="signPass" class="input-ui" placeholder="Set Password">
                <button onclick="handleSignup()" id="signupBtn" class="btn-primary bg-slate-800">SUBMIT REQUEST</button>
                <p class="text-center text-xs text-slate-400 mt-4 cursor-pointer" onclick="toggleAuth('login')">‚Üê Back to Login</p>
            </div>
        </div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="appSection" class="hidden h-full flex flex-col">
        
        <!-- Header -->
        <header class="bg-white px-5 py-4 shadow-sm flex justify-between items-center z-20 sticky top-0 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-600 font-bold">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-slate-800 leading-none">Dashboard</h2>
                    <p class="text-[10px] text-emerald-600 font-bold mt-1" id="userBadge">‚óè ONLINE</p>
                </div>
            </div>
            <button onclick="logout()" class="w-9 h-9 rounded-full bg-red-50 text-red-500 flex items-center justify-center">
                <i class="fa-solid fa-power-off"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-5 pb-24 scroll-smooth">

            <!-- VIEW 1: REPORT DASHBOARD -->
            <div id="viewReport" class="view-pane fade-in space-y-4">
                <div class="card-ui bg-gradient-to-r from-blue-600 to-indigo-600 text-white border-none">
                    <h2 class="text-xl font-bold">Welcome Back üëã</h2>
                    <p class="text-xs opacity-90">Overview of your utility stats.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="card-ui flex items-center justify-between !mb-0">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Expense</p>
                            <h3 class="text-lg font-bold text-red-500">‚Çπ<span id="dashExpense">0</span></h3>
                        </div>
                        <i class="fa-solid fa-arrow-trend-down text-red-200 text-xl"></i>
                    </div>
                    <div class="card-ui flex items-center justify-between !mb-0">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Income</p>
                            <h3 class="text-lg font-bold text-emerald-500">‚Çπ<span id="dashIncome">0</span></h3>
                        </div>
                        <i class="fa-solid fa-arrow-trend-up text-emerald-200 text-xl"></i>
                    </div>
                </div>

                <div class="card-ui p-0 overflow-hidden">
                    <div class="p-3 border-b border-slate-100 flex justify-between">
                        <h3 class="text-xs font-bold text-slate-500 uppercase">Recent Activity</h3>
                        <button onclick="loadReportData()" class="text-xs text-indigo-600 font-bold"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                    <div id="dashHistoryList" class="p-2 text-xs">Loading...</div>
                </div>
            </div>

            <!-- VIEW 2: METER READING -->
            <div id="viewMeter" class="view-pane hidden fade-in space-y-4">
                <div class="card-ui">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-gauge-high text-orange-500"></i> Generator
                    </h3>
                    <select id="dgModel" class="input-ui font-bold mb-3">
                        <option value="0">Select Unit...</option>
                        <option value="40">Kirloskar 7.5 kVA (40 L)</option>
                        <option value="50">Kirloskar 15 kVA (50 L)</option>
                        <option value="75">Kirloskar 30 kVA (75 L)</option>
                        <option value="80">Cummins 35 kVA (80 L)</option>
                        <option value="100">Ashok Leyland 40 kVA (100 L)</option>
                        <option value="150">Mahindra 60 kVA (150 L)</option>
                        <option value="160">Kirloskar 82.5 kVA (160 L)</option>
                        <option value="180">Ashok Leyland 100 kVA (180 L)</option>
                        <option value="200">Cummins 125 kVA (200 L)</option>
                        <option value="250">Kirloskar 160 kVA (250 L)</option>
                        <option value="350">Ashok Leyland 250 kVA (350 L)</option>
                        <option value="-1">Custom Tank</option>
                    </select>
                    <input type="number" id="dgCustom" class="input-ui mb-3 hidden" placeholder="Capacity (L)">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="dgHeight" value="7.0" class="input-ui text-center font-bold" placeholder="Height">
                        <input type="number" id="dgReading" placeholder="Reading" class="input-ui text-center font-bold text-indigo-600">
                    </div>
                </div>

                <div class="card-ui bg-slate-900 text-white border-none relative overflow-hidden">
                    <div class="flex justify-between items-end mb-4 relative z-10">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">FUEL LEVEL</p>
                            <p id="resPercent" class="text-4xl font-bold text-orange-400">0%</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">VOLUME</p>
                            <p id="resQty" class="text-2xl font-bold">0.0 L</p>
                        </div>
                    </div>
                    <div class="w-full h-2 bg-slate-700 rounded-full mb-4 relative z-10">
                        <div id="progressBar" class="h-full bg-orange-500 w-0 transition-all duration-700 rounded-full"></div>
                    </div>
                    <button onclick="saveMeter()" id="saveMeterBtn" class="w-full bg-white text-slate-900 py-3 rounded-lg text-xs font-bold uppercase relative z-10">LOG READING</button>
                    <i class="fa-solid fa-gas-pump absolute -right-5 -bottom-5 text-9xl text-white opacity-5"></i>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Recent Readings</h3>
                    <div id="meterHistoryList" class="space-y-2">
                         <p class="text-center text-xs text-slate-400 py-2">No history loaded.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: FUEL PRICE -->
            <div id="viewFuel" class="view-pane hidden fade-in space-y-4">
                <div class="card-ui">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase">Market Rates</h3>
                        <button onclick="fetchFuelPrices()" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold"><i class="fa-solid fa-rotate"></i> Sync</button>
                    </div>
                    <select id="fuelState" class="input-ui mb-4 text-sm font-bold" onchange="updateFuelDisplay()"><option>Select State...</option></select>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                            <p class="text-[9px] font-bold text-emerald-600">PETROL</p>
                            <p id="pricePetrol" class="font-bold text-slate-800">--</p>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-[9px] font-bold text-blue-600">DIESEL</p>
                            <p id="priceDiesel" class="font-bold text-slate-800">--</p>
                        </div>
                        <div class="p-2 bg-amber-50 rounded-lg border border-amber-100">
                            <p class="text-[9px] font-bold text-amber-600">CNG</p>
                            <p id="priceCNG" class="font-bold text-slate-800">--</p>
                        </div>
                    </div>
                </div>

                <div class="card-ui">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Calculator</h3>
                    <div class="flex gap-2 mb-3">
                        <button onclick="setCalcMode('cost')" id="btnCost" class="flex-1 py-2 text-[10px] font-bold rounded bg-slate-800 text-white">QTY ‚Üí COST</button>
                        <button onclick="setCalcMode('qty')" id="btnQty" class="flex-1 py-2 text-[10px] font-bold rounded bg-slate-100 text-slate-500">COST ‚Üí QTY</button>
                    </div>
                    <div class="flex gap-2 items-center mb-3">
                        <select id="calcFuelType" class="input-ui w-1/3 !py-2 text-[10px] font-bold"><option>Petrol</option><option>Diesel</option><option>CNG</option></select>
                        <input type="number" id="calcInput" class="input-ui font-bold text-lg text-right" placeholder="0.00" oninput="runFuelCalc()">
                    </div>
                    <div class="flex justify-between items-center bg-slate-900 p-3 rounded-lg text-white mb-3">
                        <span class="text-[10px] font-bold opacity-70">ESTIMATED</span>
                        <span id="calcResult" class="font-mono text-xl font-bold text-yellow-400">0.00</span>
                    </div>
                    <div class="pt-3 border-t border-slate-100 flex gap-2">
                         <select id="calcVehicle" class="input-ui text-xs py-2"><option value="">Select Vehicle...</option></select>
                         <button onclick="saveFuelCalc()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold w-1/3">SAVE</button>
                    </div>
                </div>

                <div>
                     <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Recent Records</h3>
                     <div id="fuelHistoryList" class="space-y-2">
                         <p class="text-center text-xs text-slate-400 py-2">No history.</p>
                     </div>
                </div>
            </div>

            <!-- VIEW 4: ADMIN -->
            <div id="viewAdmin" class="view-pane hidden fade-in">
                <div class="card-ui">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 border-b border-slate-100 pb-2">Admin Console</h3>
                    <div class="space-y-3">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                             <p class="text-[10px] font-bold text-slate-500 mb-2">ADD USER</p>
                             <input id="uName" placeholder="Name" class="input-ui mb-2 text-xs">
                             <input id="uEmail" placeholder="Email" class="input-ui mb-2 text-xs">
                             <div class="flex gap-2 mb-2">
                                 <input id="uPass" placeholder="Pass" class="input-ui text-xs">
                                 <select id="uRole" class="input-ui text-xs"><option>User</option><option>Admin</option></select>
                             </div>
                             <button onclick="submitAdminUser()" class="w-full bg-blue-600 text-white py-2 rounded text-[10px] font-bold">CREATE</button>
                        </div>
                        <a href="https://docs.google.com/spreadsheets" target="_blank" class="block text-center p-3 bg-green-50 text-green-700 rounded-lg text-xs font-bold border border-green-100">OPEN GOOGLE DATABASE</a>
                        <div id="adminUserList" class="text-[10px] h-32 overflow-y-auto">Loading...</div>
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM NAV (BIG ICONS) -->
        <nav class="bottom-nav">
            <div onclick="switchView('Report')" class="nav-item active"><i class="fa-solid fa-chart-pie"></i></div>
            <div onclick="switchView('Meter')" class="nav-item"><i class="fa-solid fa-gauge-high"></i></div>
            <div onclick="switchView('Fuel')" class="nav-item"><i class="fa-solid fa-gas-pump"></i></div>
            <div id="adminMobile" onclick="switchView('Admin')" class="nav-item hidden text-red-500"><i class="fa-solid fa-lock"></i></div>
        </nav>

    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwuZevWQeFNwy41e-z40ymvbsyo8bPigXr4z2270uTdpeRm7d2KH2LV7i41y1qi-N2k-g/exec';
        let currentUser = null;
        let fuelData = [];
        let fleetData = [];

        // --- FIXED 36 STATES DATA ---
        const HARDCODED_FUEL_PRICES = {
            "Andhra Pradesh (State)": { "Petrol": 109.57, "Diesel": 97.39, "CNG": 88.17 },
            "Arunachal Pradesh (State)": { "Petrol": 92.34, "Diesel": 81.86, "CNG": 0 },
            "Assam (State)": { "Petrol": 98.93, "Diesel": 90.15, "CNG": 87.13 },
            "Bihar (State)": { "Petrol": 106.28, "Diesel": 92.47, "CNG": 91.58 },
            "Chhattisgarh (State)": { "Petrol": 101.62, "Diesel": 94.55, "CNG": 81.04 },
            "Goa (State)": { "Petrol": 96.61, "Diesel": 88.37, "CNG": 92.00 },
            "Gujarat (State)": { "Petrol": 95.00, "Diesel": 90.68, "CNG": 82.19 },
            "Haryana (State)": { "Petrol": 95.79, "Diesel": 88.23, "CNG": 86.37 },
            "Himachal Pradesh (State)": { "Petrol": 94.58, "Diesel": 86.62, "CNG": 91.98 },
            "Jharkhand (State)": { "Petrol": 98.55, "Diesel": 93.29, "CNG": 89.27 },
            "Karnataka (State)": { "Petrol": 103.38, "Diesel": 91.41, "CNG": 84.80 },
            "Kerala (State)": { "Petrol": 106.35, "Diesel": 95.30, "CNG": 89.38 },
            "Madhya Pradesh (State)": { "Petrol": 107.40, "Diesel": 92.75, "CNG": 88.60 },
            "Maharashtra (State)": { "Petrol": 104.72, "Diesel": 91.25, "CNG": 87.91 },
            "Manipur (State)": { "Petrol": 99.83, "Diesel": 85.85, "CNG": 0 },
            "Meghalaya (State)": { "Petrol": 95.89, "Diesel": 87.31, "CNG": 0 },
            "Mizoram (State)": { "Petrol": 99.49, "Diesel": 88.44, "CNG": 0 },
            "Nagaland (State)": { "Petrol": 97.67, "Diesel": 89.01, "CNG": 0 },
            "Odisha (State)": { "Petrol": 102.07, "Diesel": 93.63, "CNG": 89.19 },
            "Punjab (State)": { "Petrol": 97.97, "Diesel": 87.78, "CNG": 87.29 },
            "Rajasthan (State)": { "Petrol": 105.44, "Diesel": 90.89, "CNG": 89.11 },
            "Sikkim (State)": { "Petrol": 103.30, "Diesel": 90.45, "CNG": 0 },
            "Tamil Nadu (State)": { "Petrol": 101.81, "Diesel": 93.40, "CNG": 85.73 },
            "Telangana (State)": { "Petrol": 108.03, "Diesel": 96.24, "CNG": 95.64 },
            "Tripura (State)": { "Petrol": 97.25, "Diesel": 86.31, "CNG": 0 },
            "Uttar Pradesh (State)": { "Petrol": 95.12, "Diesel": 88.25, "CNG": 90.73 },
            "Uttarakhand (State)": { "Petrol": 93.81, "Diesel": 88.70, "CNG": 98.75 },
            "West Bengal (State)": { "Petrol": 105.84, "Diesel": 92.41, "CNG": 0 }, 
            "Andaman and Nicobar Islands (UT)": { "Petrol": 82.46, "Diesel": 78.05, "CNG": 0 },
            "Chandigarh (UT)": { "Petrol": 94.30, "Diesel": 82.45, "CNG": 92.00 },
            "Dadra and Nagar Haveli and Daman and Diu (UT)": { "Petrol": 92.74, "Diesel": 88.23, "CNG": 77.77 },
            "Delhi (National Capital Territory - UT)": { "Petrol": 94.77, "Diesel": 87.67, "CNG": 77.09 },
            "Jammu and Kashmir (UT)": { "Petrol": 98.87, "Diesel": 85.46, "CNG": 94.40 },
            "Ladakh (UT)": { "Petrol": 104.09, "Diesel": 91.68, "CNG": 0 },
            "Lakshadweep (UT)": { "Petrol": 100.75, "Diesel": 0, "CNG": 0 }, 
            "Puducherry (UT)": { "Petrol": 95.78, "Diesel": 85.86, "CNG": 78.00 }
        };

        const dgCapacities = { "40":40, "50":50, "75":75, "80":80, "100":100, "150":150, "160":160, "180":180, "200":200, "250":250, "350":350 };

        // AUTH
        function toggleAuth(mode) {
            document.getElementById('loginForm').classList.toggle('hidden', mode==='signup');
            document.getElementById('signupForm').classList.toggle('hidden', mode==='login');
        }
        async function handleLogin() {
            const e = document.getElementById('logEmail').value;
            const p = document.getElementById('logPass').value;
            if(!e || !p) return alert('Enter credentials');
            document.getElementById('loginBtn').innerText = 'Verifying...';
            try {
                const res = await apiCall({ action:'login', email:e, password:p });
                if(res.status === 'success') { currentUser = res.user; initApp(); } 
                else alert(res.message);
            } catch(e) { alert('Connection Error'); }
            document.getElementById('loginBtn').innerText = 'LOGIN DASHBOARD';
        }
        async function handleSignup() {
            const n = document.getElementById('signName').value, e = document.getElementById('signEmail').value, p = document.getElementById('signPass').value;
            const res = await apiCall({ action:'signup', name:n, email:e, password:p });
            if(res.status === 'success') { alert(res.message); toggleAuth('login'); } else alert(res.message);
        }
        function logout() { location.reload(); }

        function initApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            if(currentUser.role === 'Super Admin') {
                document.getElementById('adminMobile').classList.remove('hidden');
                loadUsers();
            }
            populateFuelDropdown();
            loadFleetData();
            loadReportData();
            
            // Initial Histories
            fetchLastMeter();
            loadMeterHistory();
            loadFuelHistory();
        }

        function switchView(view) {
            document.querySelectorAll('.view-pane').forEach(el => el.classList.add('hidden'));
            document.getElementById('view'+view).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Logic to highlight nav
            const map = { 'Report':0, 'Meter':1, 'Fuel':2, 'Admin':3 };
            if(map[view] !== undefined) document.querySelectorAll('.nav-item')[map[view]].classList.add('active');
        }

        // --- DASHBOARD REPORT ---
        async function loadReportData() {
            const [refuels, incomes, expenses] = await Promise.all([
                apiCall({action:'fetch', sheet:'refuel'}),
                apiCall({action:'fetch', sheet:'income'}),
                apiCall({action:'fetch', sheet:'expense'})
            ]);

            let totalExp = 0, totalInc = 0, history = [];
            
            if(refuels.data) refuels.data.forEach(r => { totalExp += parseFloat(r.Cost||0); history.push({t:'Refuel', v:r.Cost, d:r.Date}); });
            if(expenses.data) expenses.data.forEach(r => { totalExp += parseFloat(r.Notes||0); history.push({t:'Expense', v:r.Notes, d:r.Date}); });
            if(incomes.data) incomes.data.forEach(r => { totalInc += parseFloat(r.Amount||0); history.push({t:'Income', v:r.Amount, d:r.Date, isInc:true}); });

            document.getElementById('dashExpense').innerText = totalExp.toFixed(0);
            document.getElementById('dashIncome').innerText = totalInc.toFixed(0);

            history.sort((a,b) => new Date(b.d) - new Date(a.d));
            document.getElementById('dashHistoryList').innerHTML = history.slice(0,5).map(h => 
                `<div class="flex justify-between items-center p-3 border-b border-slate-100 last:border-0">
                    <div><p class="text-xs font-bold text-slate-700">${h.t}</p><p class="text-[10px] text-slate-400">${h.d.substring(0,10)}</p></div>
                    <span class="text-sm font-bold ${h.isInc?'text-emerald-500':'text-red-500'}">${h.isInc?'+':'-'}‚Çπ${h.v}</span>
                </div>`
            ).join('');
        }

        // --- METER LOGIC ---
        ['dgModel','dgCustom','dgHeight','dgReading'].forEach(id=>document.getElementById(id).addEventListener('input', calcMeter));
        async function fetchLastMeter() {
            const res = await apiCall({ action:'fetch', sheet:'meter' });
            if(res.status === 'success' && res.data.length > 0) document.getElementById('dgHeight').value = res.data[0].Height || 7.0;
        }
        function calcMeter() {
            const h = parseFloat(document.getElementById('dgHeight').value)||0;
            const r = parseFloat(document.getElementById('dgReading').value)||0;
            let cap = document.getElementById('dgModel').value == -1 ? parseFloat(document.getElementById('dgCustom').value)||0 : parseFloat(document.getElementById('dgModel').value)||0;
            if(h>0) {
                const pct = (r/h)*100;
                document.getElementById('resPercent').innerText = pct.toFixed(1)+'%';
                document.getElementById('resQty').innerText = ((pct/100)*cap).toFixed(1)+' L';
            }
        }
        async function saveMeter() {
            const p = { action:'meter_reading', data:[new Date(), document.getElementById('dgModel').value, 0, document.getElementById('dgHeight').value, document.getElementById('dgReading').value, document.getElementById('resQty').innerText, document.getElementById('resPercent').innerText] };
            if(await apiCall(p)) { alert('Saved!'); loadMeterHistory(); }
        }
        async function loadMeterHistory() {
            const res = await apiCall({ action:'fetch', sheet:'meter' });
            if(res.status === 'success') {
                document.getElementById('meterHistoryList').innerHTML = res.data.slice(0,5).map(r => 
                    `<div class="history-item">
                        <div><span class="text-[10px] text-slate-400 block">${r.Date.substring(0,10)}</span><span class="text-xs font-bold text-slate-700">${r['DG Model']}</span></div>
                        <div class="text-right"><span class="text-xs font-mono font-bold text-indigo-500">${r.Percentage}</span><br><span class="text-[9px] text-slate-500">${r.Quantity}</span></div>
                    </div>`
                ).join('');
            }
        }

        // --- FUEL LOGIC ---
        function populateFuelDropdown() {
            const s = document.getElementById('fuelState');
            s.innerHTML='<option>Select...</option>';
            Object.keys(HARDCODED_FUEL_PRICES).sort().forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`);
        }
        function updateFuelDisplay() {
            const st = document.getElementById('fuelState').value;
            if(HARDCODED_FUEL_PRICES[st]) {
                document.getElementById('pricePetrol').innerText = '‚Çπ'+HARDCODED_FUEL_PRICES[st].Petrol;
                document.getElementById('priceDiesel').innerText = '‚Çπ'+HARDCODED_FUEL_PRICES[st].Diesel;
                document.getElementById('priceCNG').innerText = '‚Çπ'+HARDCODED_FUEL_PRICES[st].CNG;
            }
        }
        let calcMode = 'cost';
        function setCalcMode(m) { calcMode = m; runFuelCalc(); }
        function runFuelCalc() {
            const type = document.getElementById('calcFuelType').value;
            const val = parseFloat(document.getElementById('calcInput').value)||0;
            const price = parseFloat(document.getElementById('price'+type).innerText.replace('‚Çπ',''))||0;
            const res = document.getElementById('calcResult');
            if(calcMode === 'cost') res.innerText = '‚Çπ ' + (val * price).toFixed(2); else res.innerText = (val / price).toFixed(2) + ' L';
        }
        
        async function saveFuelCalc() {
            const v = document.getElementById('calcVehicle').value;
            if(!v) return alert('Select Vehicle');
            const type = document.getElementById('calcFuelType').value;
            const val = parseFloat(document.getElementById('calcInput').value)||0;
            const price = parseFloat(document.getElementById('price'+type).innerText.replace('‚Çπ',''))||0;
            
            let cost=0, qty=0;
            if(calcMode === 'cost') { cost = val*price; qty = val; } else { qty = val/price; cost = val; }
            const data = [new Date(), v, 0, type, price, qty.toFixed(2), cost.toFixed(2), 'Calc', 'Self'];
            if(await apiCall({ action:'refuel', data:data })) { alert('Saved!'); loadFuelHistory(); loadReportData(); }
        }

        async function loadFuelHistory() {
            const res = await apiCall({ action:'fetch', sheet:'refuel' });
            if(res.status === 'success') {
                document.getElementById('fuelHistoryList').innerHTML = res.data.slice(0,5).map(r => 
                    `<div class="history-item" style="border-left-color: #22c55e;">
                        <div><span class="text-[10px] text-slate-400 block">${r.Date.substring(0,10)}</span><span class="text-xs font-bold text-slate-700">${r.Plate}</span></div>
                        <div class="text-right"><span class="text-xs font-mono font-bold text-green-600">‚Çπ${r.Cost}</span></div>
                    </div>`
                ).join('');
            }
        }

        // --- ADMIN & OTHERS ---
        async function loadFleetData() {
            const res = await apiCall({ action:'fetch', sheet:'register' });
            if(res.status === 'success') {
                const fSel = document.getElementById('calcVehicle');
                fSel.innerHTML = '<option value="">Select Vehicle...</option>';
                res.data.forEach(v => fSel.innerHTML += `<option value="${v.Plate}">${v.Plate}</option>`);
            }
        }
        async function submitAdminUser() {
            const u = { action:'admin_create_user', name:document.getElementById('uName').value, email:document.getElementById('uEmail').value, password:document.getElementById('uPass').value, role:document.getElementById('uRole').value };
            if(await apiCall(u)) { alert('Created'); loadUsers(); }
        }
        async function loadUsers() {
            const res = await fetch(`${API_URL}?action=fetch_users`);
            const json = await res.json();
            if(json.status==='success') {
                document.getElementById('adminUserList').innerHTML = json.data.map(u => `<div class="p-2 border-b border-gray-100 flex justify-between text-slate-500 text-xs"><span>${u.name}</span><span class="text-[9px] bg-slate-100 px-2 py-1 rounded-full">${u.role}</span></div>`).join('');
            }
        }
        async function apiCall(body) {
            try { const r = await fetch(API_URL, { method:'POST', body:JSON.stringify(body) }); return await r.json(); } catch(e){ return {status:'error', message:e}; }
        }
    </script>
</body>
</html>
